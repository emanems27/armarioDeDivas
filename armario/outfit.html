<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Tu Outfit Montado</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            background-color: #ee7ce7;
            background-image: url('assets/fondorosa.jpg');
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            font-family: 'Press Start 2P', cursive;
        }

        /* Estilo de Ventana Windows 98 */
        .window {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 2px;
            box-shadow: 2px 2px 0px #000;
            width: fit-content;
        }

        .title-bar {
            background: linear-gradient(90deg, #8f0288, #e641ba);
            padding: 3px 10px;
            color: white;
            font-size: 12px;
            margin-bottom: 10px;
        }

        /* Contenedor en REJILLA */
        .canvas-outfit {
            border: 3px inset #fff;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            align-items: center;
            justify-items: center;
        }

        .canvas-outfit img {
            max-height: 140px;
            max-width: 140px;
            object-fit: contain;
        }

        .buttons-container {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        button {
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #060606 #808080 #ffffff;
            cursor: pointer;
        }

        button:active {
            border-color: #808080 #ffffff #ffffff #808080;
        }

        .window-bg-selector {
            width: 200px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .window-bg-selector .window-body {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            width: 100%;
        }

        .window-labels {
            width: 200px;
            margin-top: 20px;
        }

        #outfit-name,
        #outfit-tag {
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #ffffff;
            /* Borde hundido */
            background-color: #eee;
        }

        .window-postit * {
            box-sizing: border-box;
        }

        .window-postit {
            width: 100% !important;
            /* Se ajustará al ancho de la side-column */
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }

        .window-postit .window-body {
            padding: 6px;
            /* Espacio entre el borde de la ventana y el papel del post-it */
            display: flex;
            flex-direction: column;
        }

        #postit-text {
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #ffffff;
            /* Borde hundido */
            padding: 8px;
        }

        .window-music-player {
            width: 250px;
            background: #c0c0c0;
        }

        .player-body {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Pantalla verde pixelada estilo retro */
        .player-screen {
            background: #000;
            border: 2px inset #fff;
            padding: 5px;
            color: #00ff00;
            font-family: 'monospace';
            font-size: 10px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            text-transform: uppercase;
        }

        .player-controls {
            display: flex;
            justify-content: space-between;
            gap: 2px;
        }

        .player-btn {
            flex: 1;
            font-family: 'Arial';
            /* Para que los símbolos se vean claros */
            font-weight: bold;
            font-size: 12px;
            padding: 5px 0;
        }

        .load-btn {
            width: 100%;
            margin-top: 5px;
            font-size: 9px !important;
        }

        /* Estilizar el control de audio nativo es limitado, pero podemos darle un fondo */
        #audio-player {
            background-color: #c0c0c0;
            /* Para que combine */
            border: 1px solid #808080;
            box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #ffffff;
        }

        /* Nuevo layout de columnas */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
        }

        .side-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 250px;
        }

        .center-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Ajuste para que las ventanas laterales no se estiren */
        .window-labels,
        .window-postit,
        .window-music-player {
            width: 100% !important;
        }

        /* Mantener el outfit con su tamaño */
        #capture-area {
            width: 550px;
            /* Ajusta según el tamaño de tu outfit */
        }
    </style>
</head>

<body>
    <div class="main-container">

        <div class="side-column">
            <div class="window window-labels">
                <div class="title-bar">
                    <div class="title-bar-text">ETIQUETAS</div>
                </div>
                <div class="window-body" style="flex-direction: column; gap: 10px; padding: 10px;">
                    <input type="text" id="outfit-name" placeholder="Nombre outfit..."
                        style="width: 100%; font-family: 'Press Start 2P', cursive; font-size: 8px; padding: 5px; border: 1px solid #808080;">
                    <select id="outfit-tag"
                        style="width: 100%; font-family: 'Press Start 2P', cursive; font-size: 8px; padding: 5px; border: 1px solid #808080;">
                        <option value="">CATEGORÍA</option>
                        <option value="Casual">Casual</option>
                        <option value="Fiesta">Fiesta</option>
                        <option value="Universidad">Universidad</option>
                        <option value="Noche">Noche</option>
                    </select>
                    <div id="tag-preview" style="font-size: 8px; color: #555; margin-top: 5px;"></div>
                </div>
            </div>

            <div class="window window-postit">
                <div class="title-bar">
                    <div class="title-bar-text">NOTA.TXT</div>
                </div>
                <div class="window-body" style="padding: 5px;">
                    <textarea id="postit-text" placeholder="Escribe tus notas aquí..."
                        style="width: 100%; height: 120px; background-color: #f6c9f6; border: 1px solid #808080; font-family: 'Press Start 2P', cursive; font-size: 10px; resize: none;"></textarea>
                </div>
            </div>
        </div>

        <div class="center-column">
            <div class="window" id="capture-area">
                <div class="title-bar">Mi_Outfit.exe</div>
                <div id="contenedor-outfit" class="canvas-outfit">
                </div>
            </div>

            <div class="buttons-container">
                <button onclick="window.history.back()">VOLVER</button>
                <button onclick="descargarPNG()">GUARDAR PNG</button>
            </div>

            <div class="window window-bg-selector">
                <div class="title-bar">
                    <div class="title-bar-text">FONDO</div>
                </div>
                <div class="window-body">
                    <button onclick="prevBackground()">◀</button>
                    <img id="current-background-preview" src="" alt="Fondo"
                        style="max-height: 60px; max-width: 80px; object-fit: contain;">
                    <button onclick="nextBackground()">▶</button>
                </div>
            </div>
        </div>

        <div class="side-column">
            <div class="window window-music-player">
                <div class="title-bar">
                    <div class="title-bar-text">WINPLAY_PIXEL.EXE</div>
                </div>
                <div class="window-body player-body">
                    <div class="player-screen">
                        <div id="song-title">NO DISCO</div>
                        <div id="status-text">STOPPED</div>
                    </div>

                    <div class="player-controls">
                        <button class="player-btn" onclick="prevSong()">◀◀</button>
                        <button class="player-btn" onclick="playAudio()">▶</button>
                        <button class="player-btn" onclick="pauseAudio()">||</button>
                        <button class="player-btn" onclick="nextSong()">▶▶</button>
                    </div>

                    <input type="file" id="upload-music" style="display:none" accept="audio/*"
                        onchange="loadMusic(event)">
                    <button onclick="document.getElementById('upload-music').click()" class="load-btn">EJECT /
                        LOAD</button>

                    <audio id="audio-element"></audio>
                </div>
            </div>
        </div>

    </div>


    <script>
        const datos = JSON.parse(localStorage.getItem('outfitSeleccionado'));
        const contenedor = document.getElementById('contenedor-outfit');

        // Renderizar las imágenes
        if (datos) {
            Object.entries(datos).forEach(([key, src]) => {
                if (src && src !== "" && !src.includes('undefined')) {
                    const img = document.createElement('img');
                    // IMPORTANTE: Permitir crossOrigin si las imágenes vienen de otro servidor
                    img.crossOrigin = "anonymous";
                    img.src = src;
                    img.alt = key;
                    contenedor.appendChild(img);
                }
            });
        }

        async function descargarPNG() {
            const area = document.getElementById('capture-area');

            // Usamos html2canvas para convertir el DIV en un Canvas
            html2canvas(area, {
                backgroundColor: "#008080", // Fondo que tendrá la imagen final
                useCORS: true // Permite capturar imágenes de servidores externos
            }).then(canvas => {
                // Convertimos el canvas a una URL de imagen PNG
                const image = canvas.toDataURL("image/png");

                // Creamos un enlace invisible para forzar la descarga
                const link = document.createElement('a');
                link.download = `outfit-${Date.now()}.png`;
                link.href = image;
                link.click();
            });
        }

        // 1. Empezamos con el vector vacío
        let backgrounds = [];
        let currentBackgroundIndex = 0;

        // 2. Función para leer el JSON y llenar el vector
        async function cargarFondos() {
            try {
                // Buscamos el archivo JSON en la ruta correcta
                const response = await fetch('assets/fondos/files.json');

                if (!response.ok) throw new Error("No se encontró el archivo JSON");

                // Guardamos los datos del JSON en nuestro vector backgrounds
                backgrounds = await response.json();

                console.log("Fondos cargados correctamente:", backgrounds);

                // Una vez que tenemos los datos, mostramos el primero
                if (backgrounds.length > 0) {
                    updateBackground();
                }
            } catch (error) {
                console.error("Error cargando el JSON de fondos:", error);
                // Opcional: poner un fondo por defecto si el JSON falla
                backgrounds = ["assets/fondos/fondo2.jpg"];
                updateBackground();
            }
        }

        // 3. Tus funciones de actualización (se quedan casi igual, solo añadimos validación)
        function updateBackground() {
            if (backgrounds.length === 0) return; // Si no hay fondos, no hacemos nada

            const bgUrl = backgrounds[currentBackgroundIndex];
            const captureArea = document.getElementById('capture-area');
            const previewImg = document.getElementById('current-background-preview');

            if (captureArea) {
                captureArea.style.backgroundImage = `url('${bgUrl}')`;
                captureArea.style.backgroundSize = 'cover';
                captureArea.style.backgroundPosition = 'center';
            }

            if (previewImg) {
                previewImg.src = bgUrl;
            }
        }

        function nextBackground() {
            if (backgrounds.length === 0) return;
            currentBackgroundIndex = (currentBackgroundIndex + 1) % backgrounds.length;
            updateBackground();
        }

        function prevBackground() {
            if (backgrounds.length === 0) return;
            currentBackgroundIndex = (currentBackgroundIndex - 1 + backgrounds.length) % backgrounds.length;
            updateBackground();
        }

        // 4. Cambiamos el DOMContentLoaded para que llame a la función de carga
        document.addEventListener('DOMContentLoaded', () => {
            cargarFondos();
        });



        document.addEventListener('DOMContentLoaded', () => {
            updateBackground();
            // Añadir listener para actualizar la vista previa de la etiqueta
            document.getElementById('outfit-name').addEventListener('input', updateTagPreview);
            document.getElementById('outfit-tag').addEventListener('change', updateTagPreview);
        });

        function updateTagPreview() {
            const name = document.getElementById('outfit-name').value.trim();
            const tag = document.getElementById('outfit-tag').value.trim();
            let previewText = "";
            if (tag) previewText += `[${tag}]`;
            if (name) previewText += ` ${name}`;
            document.getElementById('tag-preview').textContent = previewText;
        }


        async function descargarPNG() {
            const area = document.getElementById('capture-area');

            // Capturamos el texto de la etiqueta antes de generar la imagen
            const outfitNameInput = document.getElementById('outfit-name').value.trim();
            const outfitTagSelect = document.getElementById('outfit-tag').value.trim();

            let fileName = "outfit";
            if (outfitTagSelect) {
                fileName += `_${outfitTagSelect.toLowerCase()}`;
            }
            if (outfitNameInput) {
                fileName += `_${outfitNameInput.replace(/\s+/g, '-').toLowerCase()}`;
            }
            fileName += `_${Math.floor(Date.now() / 1000)}.png`; // Añadimos timestamp para unicidad

            html2canvas(area, {
                backgroundColor: null, // Que el fondo sea el que has puesto en la ventana o body
                useCORS: true,
                scale: 2 // Buena calidad
            }).then(canvas => {
                const image = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = fileName; // Usamos el nombre generado
                link.href = image;
                link.click();
                alert(`¡"${fileName}" generado y descargado a tu carpeta de descargas!`);
            });
        }

        const audio = document.getElementById('audio-element');
        const statusText = document.getElementById('status-text');
        const songTitle = document.getElementById('song-title');

        // Lista de reproducción (puedes añadir los nombres de tus archivos aquí)
        let playlist = [
            { url: 'audios/Musica.mp3', name: 'DTI_THEME' },
            { url: 'audios/bratz.mp3', name: 'bratzzzz' },
            { url: 'audios/monster.mp3', name: 'monster_high.mp3' },
            { url: 'audios/phone.mp3', name: 'LOL.mp3' },
            { url: 'audios/satisfaction.mp3', name: 'SATISFACTION_THEME' },
            { url: 'audios/y2k.mp3', name: 'Y2K_THEME' }

        ];
        let currentTrackIndex = 0;

        function loadMusic(event) {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                playlist.push({ url: url, name: file.name });
                currentTrackIndex = playlist.length - 1;
                playTrack(currentTrackIndex);
            }
        }

        function playTrack(index) {
            if (playlist[index]) {
                audio.src = playlist[index].url;

                // Intentamos reproducir y capturamos el error si falla
                audio.play().then(() => {
                    songTitle.innerText = playlist[index].name;
                    statusText.innerText = "PLAYING...";
                    console.log("Reproduciendo: " + playlist[index].name);
                }).catch(error => {
                    statusText.innerText = "ERR: NO AUDIO";
                    console.error("Error al reproducir:", error);
                });
            }
        }

        function playAudio() {
            if (audio.src) {
                audio.play();
                statusText.innerText = "PLAYING...";
            }
        }

        function pauseAudio() {
            audio.pause();
            statusText.innerText = "PAUSED";
        }

        function nextSong() {
            if (playlist.length > 0) {
                currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
                playTrack(currentTrackIndex);
            }
        }

        function prevSong() {
            if (playlist.length > 0) {
                currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
                playTrack(currentTrackIndex);
            }
        }
    </script>
</body>

</html>
